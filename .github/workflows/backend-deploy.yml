name: FastAPI Backend CI/CD

on:
  push:
    branches: [ dev, main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  pull_request:
    branches: [ dev, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
    
    - name: Run linting (optional)
      run: |
        pip install flake8 black
        black --check backend/ || true
        flake8 backend/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
    
    - name: Run tests
      run: |
        pytest backend/ -v --tb=short || true

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./backend/Dockerfile
        push: true
        tags: ghcr.io/${{ github.repository }}/stacknstay-backend:${{ github.sha }},ghcr.io/${{ github.repository }}/stacknstay-backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    # Example: Deploy to Railway (uncomment and set RAILWAY_TOKEN secret)
    # - name: Deploy to Railway
    #   uses: railwayapp/deploy-action@v1
    #   env:
    #     RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    
    # Example: Deploy to Fly.io (uncomment and set FLY_API_TOKEN secret)
    # - name: Deploy to Fly.io
    #   uses: superfly/flyctl-actions/setup-flyctl@master
    # - run: flyctl deploy --remote-only
    #   env:
    #     FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
    
    # Example: Deploy to Render (uncomment and set RENDER_DEPLOY_HOOK secret)
    # - name: Deploy to Render
    #   run: |
    #     curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
    
    - name: Notify deployment
      run: echo "Backend deployment placeholder. Configure Railway/Fly.io/Render webhook above."
